import{m as V,_ as R,u as q,a as Y,r as g,o as G,p as I,b as J,d as l,e as i,f as t,t as r,j as _,l as K,n as p,i as h,k as P,F as w,g as C,w as D,q as $,h as Q,B as W}from"./index-606e0833.js";import{H as X}from"./heart-98382468.js";const Z=V("ShareIcon",[["path",{d:"M4 12v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8",key:"1b2hhj"}],["polyline",{points:"16 6 12 2 8 6",key:"m901s6"}],["line",{x1:"12",x2:"12",y1:"2",y2:"15",key:"1p0rca"}]]),ee=V("VolumeIcon",[["polygon",{points:"11 5 6 9 2 9 2 15 6 15 11 19 11 5",key:"16drj5"}]]);const te={key:0,class:"max-w-4xl mx-auto"},ae={class:"bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md"},ne={class:"mb-6 text-center"},oe={class:"text-3xl font-kai text-primary dark:text-dark-primary mb-2"},se={class:"text-gray-600 dark:text-gray-400"},re={class:"flex flex-wrap justify-center gap-4 mb-6 p-3 bg-gray-50 dark:bg-gray-700 rounded-md"},le={class:"flex items-center space-x-2"},ie={key:0,class:"text-sm text-gray-500 dark:text-gray-400 mb-1"},de={class:"poem-line"},ce={key:0,class:"relative group cursor-help border-b border-dashed border-gray-400"},ue={class:"absolute bottom-full left-1/2 transform -translate-x-1/2 w-48 bg-white dark:bg-gray-700 p-2 rounded shadow-lg opacity-0 group-hover:opacity-100 transition-opacity z-10 text-sm"},me={key:1},ge={class:"flex justify-between items-center mb-8"},pe={class:"flex items-center space-x-4"},ye={class:"mt-10"},ve={class:"mb-6 bg-gray-50 dark:bg-gray-700 p-4 rounded-md"},be={class:"mb-4"},ke={class:"mb-4"},xe=["disabled"],_e={key:0},fe={class:"flex justify-between mb-2"},he={class:"font-medium"},we={class:"text-sm text-gray-500 dark:text-gray-400"},Se={class:"text-gray-700 dark:text-gray-300"},Pe={key:1,class:"text-center py-4 text-gray-500 dark:text-gray-400"},Ce={key:1,class:"text-center py-10"},Ie={__name:"PoemDetail",setup(De){const z=q(),u=Y(),s=g(null),b=g(!1),k=g(!1),y=g("medium"),x=g(!1),v=g(!1),f=g([]),d=g({nickname:localStorage.getItem("commentNickname")||"",content:""});G(async()=>{u.poems.length===0&&await u.fetchPoems(),u.poets.length===0&&await u.fetchPoets();const a=z.params.id;s.value=u.getPoemById(a),s.value&&(x.value=u.isPoemLiked(a),v.value=u.isPoemFavorited(a),T(a))});const F=a=>{const e=u.poets.find(o=>o.name===a);return e?e.id:""},S=a=>{y.value=a},j=a=>a.split(""),A=(a,e)=>a.annotations&&a.annotations.some(o=>o.word.includes(e)),N=(a,e)=>{const o=a.annotations.find(n=>n.word.includes(e));return o?o.explanation:""},B=()=>{x.value||(u.likePoem(s.value.id),x.value=!0)},L=()=>{v.value?u.unfavoritePoem(s.value.id):u.favoritePoem(s.value.id),v.value=!v.value},E=()=>{const a=window.location.href;navigator.clipboard.writeText(a).then(()=>{alert("链接已复制到剪贴板，可以分享给好友了！")}).catch(e=>{console.error("无法复制链接: ",e)})},M=()=>{if("speechSynthesis"in window){const a=s.value.content.map(o=>o.sentence).join("，"),e=new SpeechSynthesisUtterance(a);e.lang="zh-CN",speechSynthesis.speak(e)}else alert("您的浏览器不支持语音合成功能")},T=async a=>{try{const{supabase:e}=await I(()=>import("./index-606e0833.js").then(c=>c.x),["assets/index-606e0833.js","assets/index-cfd57d27.css"]),{data:o,error:n}=await e.from("poem_comments").select("*").eq("poem_id",a).order("created_at",{ascending:!1});if(n)throw n;Array.isArray(o)&&(f.value=o.map(c=>({nickname:c.nickname,content:c.content,timestamp:c.created_at})))}catch(e){console.error("加载评论失败:",e)}},U=async()=>{if(!(!d.value.nickname||!d.value.content))try{const{supabase:a,getClientUserId:e}=await I(()=>import("./index-606e0833.js").then(m=>m.x),["assets/index-606e0833.js","assets/index-cfd57d27.css"]),o=e(),{data:n,error:c}=await a.from("poem_comments").insert({poem_id:s.value.id,user_id:o,nickname:d.value.nickname,content:d.value.content,created_at:new Date().toISOString()}).select();if(c)throw c;if(n&&n.length>0){const m={nickname:n[0].nickname,content:n[0].content,timestamp:n[0].created_at};f.value.unshift(m),localStorage.setItem("commentNickname",d.value.nickname),d.value.content=""}}catch(a){console.error("提交评论失败:",a),alert("评论提交失败，请稍后再试")}},H=a=>{const e=new Date(a);return`${e.getFullYear()}-${String(e.getMonth()+1).padStart(2,"0")}-${String(e.getDate()).padStart(2,"0")} ${String(e.getHours()).padStart(2,"0")}:${String(e.getMinutes()).padStart(2,"0")}`};return(a,e)=>{const o=J("router-link");return s.value?(l(),i("div",te,[t("div",ae,[t("div",ne,[t("h1",oe,r(s.value.title),1),t("p",se,[_(o,{to:`/poet/${F(s.value.author)}`,class:"hover:underline"},{default:K(()=>[P(r(s.value.dynasty)+" · "+r(s.value.author),1)]),_:1},8,["to"])])]),t("div",re,[t("button",{onClick:e[0]||(e[0]=n=>b.value=!b.value),class:p(["btn",b.value?"btn-primary":"bg-gray-200 dark:bg-gray-600"])},r(b.value?"隐藏拼音":"显示拼音"),3),t("button",{onClick:e[1]||(e[1]=n=>k.value=!k.value),class:p(["btn",k.value?"btn-primary":"bg-gray-200 dark:bg-gray-600"])},r(k.value?"隐藏注释":"显示注释"),3),t("div",le,[t("button",{onClick:e[2]||(e[2]=n=>S("small")),class:p(["px-2 py-1 rounded",y.value==="small"?"bg-primary text-white":"bg-gray-200 dark:bg-gray-600"])},"小",2),t("button",{onClick:e[3]||(e[3]=n=>S("medium")),class:p(["px-2 py-1 rounded",y.value==="medium"?"bg-primary text-white":"bg-gray-200 dark:bg-gray-600"])},"中",2),t("button",{onClick:e[4]||(e[4]=n=>S("large")),class:p(["px-2 py-1 rounded",y.value==="large"?"bg-primary text-white":"bg-gray-200 dark:bg-gray-600"])},"大",2)]),t("button",{onClick:M,class:"btn bg-gray-200 dark:bg-gray-600 hover:bg-gray-300 dark:hover:bg-gray-500"},[_(h(ee),{size:"18",class:"mr-1"}),e[7]||(e[7]=P(" 朗读 ",-1))])]),t("div",{class:p(["mb-8 text-center",{"text-base":y.value==="small","text-xl":y.value==="medium","text-2xl":y.value==="large"}])},[(l(!0),i(w,null,C(s.value.content,(n,c)=>(l(),i("div",{key:c,class:"mb-4"},[b.value?(l(),i("div",ie,r(n.pinyin),1)):Q("",!0),t("div",de,[(l(!0),i(w,null,C(j(n.sentence),(m,O)=>(l(),i(w,{key:O},[A(n,m)&&k.value?(l(),i("span",ce,[P(r(m)+" ",1),t("span",ue,r(N(n,m)),1)])):(l(),i("span",me,r(m),1))],64))),128))])]))),128))],2),t("div",ge,[t("div",pe,[t("button",{onClick:B,class:p(["flex items-center space-x-1 focus:outline-none",{"text-red-500":x.value,"text-gray-400 hover:text-red-500":!x.value}])},[_(h(X),{size:"20"}),t("span",null,r(s.value.likes),1)],2),t("button",{onClick:L,class:p(["flex items-center space-x-1 focus:outline-none",{"text-yellow-500":v.value,"text-gray-400 hover:text-yellow-500":!v.value}])},[_(h(W),{size:"20"}),t("span",null,r(v.value?"已收藏":"收藏"),1)],2)]),t("button",{onClick:E,class:"flex items-center space-x-1 text-gray-600 dark:text-gray-400 focus:outline-none"},[_(h(Z),{size:"20"}),e[8]||(e[8]=t("span",null,"分享",-1))])]),t("div",ye,[e[11]||(e[11]=t("h3",{class:"text-xl font-kai text-primary dark:text-dark-primary mb-4"},"评论区",-1)),t("div",ve,[t("div",be,[e[9]||(e[9]=t("label",{for:"nickname",class:"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1"},"昵称",-1)),D(t("input",{type:"text",id:"nickname","onUpdate:modelValue":e[5]||(e[5]=n=>d.value.nickname=n),class:"w-full px-3 py-2 border border-gray-300 dark:border-gray-600 dark:bg-gray-800 rounded-md focus:outline-none focus:ring-2 focus:ring-primary",placeholder:"请输入您的昵称"},null,512),[[$,d.value.nickname]])]),t("div",ke,[e[10]||(e[10]=t("label",{for:"content",class:"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1"},"评论内容",-1)),D(t("textarea",{id:"content","onUpdate:modelValue":e[6]||(e[6]=n=>d.value.content=n),rows:"3",class:"w-full px-3 py-2 border border-gray-300 dark:border-gray-600 dark:bg-gray-800 rounded-md focus:outline-none focus:ring-2 focus:ring-primary",placeholder:"请输入您的评论"},null,512),[[$,d.value.content]])]),t("button",{onClick:U,class:"btn btn-primary",disabled:!d.value.nickname||!d.value.content}," 提交评论 ",8,xe)]),f.value.length>0?(l(),i("div",_e,[(l(!0),i(w,null,C(f.value,(n,c)=>(l(),i("div",{key:c,class:"border-b border-gray-200 dark:border-gray-700 py-4 last:border-0"},[t("div",fe,[t("span",he,r(n.nickname),1),t("span",we,r(H(n.timestamp)),1)]),t("p",Se,r(n.content),1)]))),128))])):(l(),i("div",Pe," 暂无评论，快来发表第一条评论吧！ "))])])])):(l(),i("div",Ce,[...e[12]||(e[12]=[t("p",null,"加载中...",-1)])]))}}},ze=R(Ie,[["__scopeId","data-v-d2a85100"]]);export{ze as default};
